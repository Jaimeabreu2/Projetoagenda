<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda ‚Äî Calend√°rio com Eventos</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <!-- usa os estilos globais do projeto -->
  <link rel="stylesheet" href="style.css" />

  <!-- ajustes locais: painel de compromissos e layout 2-colunas -->
  <style>
    /* pequenas adapta√ß√µes espec√≠ficas desta p√°gina, reutilizando vari√°veis do style.css */
    .calendar-wrap{
      display:grid;
      grid-template-columns: 360px 1fr; /* painel esquerdo + calend√°rio */
      gap:18px;
      max-width:980px;
      margin:28px auto;
      padding:14px;
    }

    /* painel de compromissos ‚Äî mais contraste */
    .agenda-panel{
      background: linear-gradient(180deg,#f8fff9 0%, #eefbf0 100%); /* levemente mais marcado */
      border-radius:12px;
      padding:18px;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08); /* sombra mais forte */
      min-height:360px;
      display:flex;
      flex-direction:column;
      border: 1px solid rgba(46,125,50,0.06);
    }
    .agenda-header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
    }
    .agenda-header h3{margin:0;font-size:16px;color:var(--text);letter-spacing:0.6px;text-transform:uppercase}
    .appointments{
      display:flex;flex-direction:column;gap:10px;margin-top:6px;
      max-height:calc(100vh - 260px);
      overflow:auto;
      padding-right:6px;
    }

    /* item de compromisso ‚Äî mais n√≠tido */
    .appointment{
      display:flex;
      gap:12px;
      align-items:center;
      background: #ffffff;
      border-radius:10px;
      padding:12px;
      border:1px solid rgba(15,23,42,0.06);
      transition:transform 160ms ease,box-shadow 160ms ease,background 160ms ease;
    }
    .appointment:hover{
      transform:translateY(-4px);
      box-shadow: 0 12px 28px rgba(15,23,42,0.08);
      background: linear-gradient(180deg,#fcfff9,#f2fff2);
    }

    /* badge colorida para destaque do dia */
    .badge{
      min-width:46px;height:46px;border-radius:10px;
      background: linear-gradient(135deg,var(--brand-1),var(--brand-2));
      color:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:700;
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      font-size:16px;
    }
    .appt-body strong{display:block;font-size:14px;color:var(--text)}
    .appt-body small{
      display:block;
      color: rgba(15,23,42,0.6); /* mais escuro que antes */
      font-size:12px;
      margin-top:4px;
    }

    /* caso queira adicionar um marcador/color accent no item (opcional) */
    .appointment::before{
      content:"";
      width:4px;
      height:40px;
      border-radius:4px;
      background: linear-gradient(180deg,var(--brand-1),var(--brand-2));
      margin-right:8px;
      display:inline-block;
      opacity:0.95;
    }

    /* make calendar column a bit more compact visually */
    .calendar-main{background:transparent}
    #calendarContent.calendar-grid{gap:10px;padding:12px}
    .calendar-cell{min-height:68px;padding:8px}

    /* destaque da c√©lula selecionada */
    .calendar-cell.selected{
      outline: 2px solid rgba(102,187,106,0.16);
      box-shadow: 0 6px 18px rgba(102,187,106,0.06);
    }

    /* estilos para dias que cont√©m evento (mais escuros) */
    .calendar-cell.has-event{
      /* fundo mais saturado / escuro para f√°cil identifica√ß√£o */
      background: linear-gradient(180deg,#bfecc0 0%, #9fd9a0 100%);
      border:1px solid rgba(46,125,50,0.22);
      box-shadow: 0 10px 22px rgba(46,125,50,0.08) inset;
    }
    .calendar-cell.has-event .day-num{
      color: #154d2b; /* verde mais escuro para contraste */
      font-weight:800;
      text-shadow: 0 1px 0 rgba(255,255,255,0.35);
    }
    /* torne o ponto de evento mais vis√≠vel */
    .calendar-cell.has-event .event-dot{
      width:10px;
      height:10px;
      background: var(--brand-1);
      box-shadow: 0 0 0 4px rgba(46,125,50,0.06);
      display:inline-block;
      border-radius:50%;
    }
    /* Esconde o texto "Sem eventos" se presente; deixamos apenas o ponto */
    .event-info small{ display:none; }

    /* responsivo: empilha colunas */
    @media (max-width:880px){
      .calendar-wrap{grid-template-columns:1fr;max-width:520px;padding:12px}
      .agenda-panel{order:2}
      .calendar-main{order:1}
    }

    /* Estilos para a barra lateral fixa */
    .app-sidebar{
      position:fixed;
      top: var(--topbar-height); /* empurra abaixo do topbar para n√£o ficar coberto */
      left:0;
      bottom:0;
      width:80px;
      background:var(--bg);
      border-right:1px solid rgba(15,23,42,0.1);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 0;
      box-shadow:var(--shadow-sm);
    }
    .icon-btn{
      background:transparent;
      border:none;
      color:var(--text);
      font-size:22px;
      cursor:pointer;
      transition:color 0.3s;
    }
    .icon-btn:hover{
      color:var(--brand-1);
    }
    .sidebar-sep{
      height:1px;
      width:80%;
      background:rgba(15,23,42,0.1);
      margin:8px 0;
    }
    .create-btn{
      background:var(--brand-1);
      color:#fff;
      border:none;
      border-radius:50%;
      width:56px;
      height:56px;
      font-size:28px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      transition:background 0.3s;
    }
    .create-btn:hover{
      background:var(--brand-2);
    }

    /* Estilos para o modal de evento */
    .event-modal{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .event-modal-panel{
      background:#fff;
      border-radius:12px;
      padding:24px;
      max-width:400px;
      width:100%;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      display:flex;
      flex-direction:column;
    }
    .event-modal h3{
      margin:0 0 16px;
      font-size:18px;
      color:var(--text);
    }
    .event-modal label{
      font-size:14px;
      color:var(--text);
      margin-bottom:4px;
    }
    .event-modal input{
      border:1px solid rgba(15,23,42,0.1);
      border-radius:8px;
      padding:10px;
      font-size:16px;
      margin-bottom:16px;
    }
    .event-modal .btn{
      margin-top:auto;
    }
    .event-modal-backdrop{
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:transparent;
      cursor:pointer;
    }

    /* Acessibilidade: foco e leitura de mudan√ßas */
    .skip-link {
      position: absolute;
      left: -999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    .skip-link:focus {
      left: 0;
      top: 0;
      width: auto;
      height: auto;
      padding: 8px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      z-index: 1001;
    }

    /* Estilos para o cabe√ßalho da aplica√ß√£o */
    .app-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      background: var(--bg);
      border-bottom: 1px solid rgba(15,23,42,0.1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 60px;
    }
    .app-topbar .brand {
      display: flex;
      align-items: center;
      font-size: 18px;
      color: var(--text);
    }
    .app-topbar .logo {
      font-weight: 700;
      margin-right: 8px;
      font-size: 22px;
    }
    .app-topbar .top-actions {
      display: flex;
      gap: 12px;
    }
    .app-topbar .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
    .app-topbar .btn.secondary {
      background: rgba(15,23,42,0.05);
      color: var(--text);
    }
    .app-topbar .btn.primary {
      background: var(--brand-1);
      color: #fff;
    }
  </style>
</head>
<body class="calendar-page">
  <!-- Topbar com usu√°rio (simula√ß√£o) -->
  <header class="app-topbar" role="banner" aria-label="Cabe√ßalho da aplica√ß√£o">
    <div class="brand"><div class="logo">Ag</div><div style="font-weight:700">Projeto Agenda</div></div>
    <div class="top-actions">
      <a class="btn secondary" href="profile.html" title="Meu Perfil">Meu Perfil</a>
      <button id="goTodayBtn" class="btn" title="Hoje" aria-label="Ir para hoje">Hoje</button>
      <button id="exportBtn" class="btn" title="Exportar eventos" aria-label="Exportar eventos">Exportar</button>
      <a class="btn primary" href="addEventScreen.html" title="Adicionar evento">Adicionar evento</a>
    </div>
  </header>

  <div class="app-container">
   <!-- Skip link para acessibilidade de teclado -->
   <a class="skip-link" href="#calendarContent" style="position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden"
     onfocus="this.style.left='16px';this.style.top='16px';this.style.width='auto';this.style.height='auto';" onblur="this.style.left='-999px'">
    Ir para o calend√°rio
  </a>

  <!-- Nova barra lateral fixa √† esquerda -->
  <nav class="app-sidebar" aria-label="Barra de navega√ß√£o">
    <!-- abre a tela do ano inteiro (nova p√°gina) -->
    <a class="icon-btn" href="yearCalendar.html" title="Calend√°rio do ano" aria-label="Calend√°rio do ano">üìÖ</a>
    <button class="icon-btn" title="Tarefas" aria-label="Tarefas">‚úÖ</button>
    <!-- Meu Perfil: abriu a p√°gina de perfil do usu√°rio -->
    <a class="icon-btn" href="profile.html" title="Meu Perfil" aria-label="Meu Perfil">üë§</a>
    <div class="sidebar-sep" aria-hidden="true"></div>
    <button id="openCreateBtn" class="create-btn" title="Adicionar evento" aria-label="Adicionar evento">+</button>
  </nav>

  <!-- Layout principal: painel de eventos (esquerda) e calend√°rio (direita). -->
  <div class="calendar-wrap">
    <!-- coluna esquerda: painel de compromissos -->
    <aside class="agenda-panel" aria-label="Eventos">
      <div class="agenda-header">
        <h3>EVENTOS</h3>
        <div class="small" id="agendaMonthLabel" aria-hidden="true"></div>
      </div>

      <!-- Busca r√°pida por t√≠tulo/descri√ß√£o -->
      <div style="margin-bottom:8px;display:flex;gap:8px;align-items:center">
        <input id="eventSearch" type="search" placeholder="Buscar eventos (t√≠tulo, nota)" aria-label="Buscar eventos" class="filter" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff">
        <button id="exportListBtn" class="btn secondary" title="Exportar lista" style="padding:8px 10px">Exportar</button>
      </div>

      <div class="appointments" id="eventsList">
        <!-- itens de exemplo; substitua dinamicamente com backend -->
        <div class="appointment">
          <div class="badge">2</div>
          <div class="appt-body">
            <strong>Disciplina A</strong>
            <small>Prova (9:30 - 11:00)</small>
          </div>
        </div>

        <div class="appointment">
          <div class="badge">16</div>
          <div class="appt-body">
            <strong>Disciplina B</strong>
            <small>Trabalho (7:30 - 9:10)</small>
          </div>
        </div>

        <div class="appointment">
          <div class="badge">22</div>
          <div class="appt-body">
            <strong>Disciplina C</strong>
            <small>Lista de Exerc√≠cios (13:30 - 15:00)</small>
          </div>
        </div>

        <!-- Observa√ß√£o: para popular dinamicamente, selecione #appointmentsList e injete nodes com badge/detais -->
      </div>
    </aside>

    <!-- coluna direita: calend√°rio (mesma estrutura do calendar.html) -->
    <div class="calendar-main">
      <div class="calendar-header">
        <div id="calendarTitle" class="calendar-title"></div>

        <div class="calendar-controls">
          <button id="prevBtn" class="btn" aria-label="Anterior">‚óÄ</button>
          <button id="nextBtn" class="btn" aria-label="Pr√≥ximo">‚ñ∂</button>
        </div>

        <div class="view-toggle">
          <button class="btn primary" data-view="month">M√™s</button>
          <button class="btn" data-view="week">Semana</button>
          <button class="btn" data-view="day">Dia</button>
        </div>
      </div>

      <div class="calendar-grid weekday-labels" id="weekdayLabels">
        <div class="calendar-weekday">Dom</div>
        <div class="calendar-weekday">Seg</div>
        <div class="calendar-weekday">Ter</div>
        <div class="calendar-weekday">Qua</div>
        <div class="calendar-weekday">Qui</div>
        <div class="calendar-weekday">Sex</div>
        <div class="calendar-weekday">S√°b</div>
      </div>

      <div id="calendarContent" class="calendar-grid" role="grid" aria-label="Calend√°rio"></div>
    </div>
  </div>
  </div> <!-- .app-container -->

  <!-- Modal simples para criar evento -->
  <!-- Modal de evento: formul√°rio simples. Preencha t√≠tulo e dia para criar evento localmente. -->
  <div id="eventModal" class="event-modal" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle" style="display:none">
    <div class="event-modal-panel" role="document">
      <h3 id="eventModalTitle">Adicionar evento</h3>
      <form id="eventForm">
        <label for="evtTitle">T√≠tulo</label>
        <input id="evtTitle" name="title" type="text" required />
        <label for="evtDay">Dia (n√∫mero)</label>
        <input id="evtDay" name="day" type="number" min="1" max="31" required />
        <label for="evtTime">Hor√°rio (ex: 09:30)</label>
        <input id="evtTime" name="time" type="text" placeholder="09:30" />
        <label for="evtNote">Descri√ß√£o</label>
        <input id="evtNote" name="note" type="text" />
        <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
          <button type="button" class="btn secondary" id="cancelEvent">Cancelar</button>
          <button type="submit" class="btn" id="saveEvent">Salvar</button>
        </div>
      </form>
    </div>
    <button class="event-modal-backdrop" id="closeModal" aria-label="Fechar"></button>
  </div>

  <script>
    // Script: fun√ß√µes para renderizar m√™s/semana/dia e gerenciar modal.
    // Coment√°rios no c√≥digo explicam pontos de extens√£o (onde integrar backend).
    (function () {
      // ...existing variable declarations...
      const content = document.getElementById('calendarContent');
      const title = document.getElementById('calendarTitle');
      const weekdayLabels = document.getElementById('weekdayLabels');
      const agendaMonthLabel = document.getElementById('agendaMonthLabel');

      // novos elementos √∫teis
      const goTodayBtn = document.getElementById('goTodayBtn');
      const exportBtn = document.getElementById('exportBtn');
      const eventSearch = document.getElementById('eventSearch');
      const exportListBtn = document.getElementById('exportListBtn');
      const eventsListEl = document.getElementById('eventsList');

      const eventDays = [2, 16, 22];
      let view = 'month';
      // permite inicializar via querystring ?y=YYYY&m=MM&d=DD
      const qs = new URLSearchParams(window.location.search);
      const startY = qs.has('y') ? parseInt(qs.get('y'),10) : null;
      const startM = qs.has('m') ? parseInt(qs.get('m'),10) : null;
      const startD = qs.has('d') ? parseInt(qs.get('d'),10) : null;
      let current = startY || startM !== null ? new Date(startY || new Date().getFullYear(), startM || 0, startD || 1) : new Date();

      // armazenamento local de eventos para permitir export/filter (preenche a partir do DOM sample ao carregar)
      const storedEvents = [];
      function parseInitialAppointments(){
        // converte as .appointment existentes no HTML para storedEvents
        if(!eventsListEl) return;
        const nodes = Array.from(eventsListEl.querySelectorAll('.appointment'));
        nodes.forEach(n => {
          const badge = n.querySelector('.badge')?.textContent?.trim();
          const title = n.querySelector('.appt-body strong')?.textContent?.trim();
          const note = n.querySelector('.appt-body small')?.textContent?.trim();
          const day = badge ? parseInt(badge,10) : null;
          if(title && day) storedEvents.push({ day, title, note });
        });
      }
      parseInitialAppointments();

      // util para criar novo item de evento na lista (usado pelo fallback e pelo POST success)
      function addEventToList(evt){
        // evt: { day, title, time?, note? }
        storedEvents.push(evt);
        const item = document.createElement('div'); item.className = 'appointment';
        const b = document.createElement('div'); b.className = 'badge'; b.textContent = evt.day;
        const body = document.createElement('div'); body.className = 'appt-body';
        const strong = document.createElement('strong'); strong.textContent = evt.title;
        const small = document.createElement('small'); small.style.display='block'; small.style.color='rgba(15,23,42,0.6)';
        small.textContent = (evt.time ? evt.time + ' ‚Ä¢ ' : '') + (evt.note || '');
        body.appendChild(strong); body.appendChild(small);
        item.appendChild(b); item.appendChild(body);
        eventsListEl.appendChild(item);
      }

      // filtro da lista de eventos
      function filterEvents(q){
        const ql = (q||'').trim().toLowerCase();
        Array.from(eventsListEl.children).forEach(item => {
          const text = (item.innerText || '').toLowerCase();
          item.style.display = ql ? (text.includes(ql) ? '' : 'none') : '';
        });
      }
      if(eventSearch) eventSearch.addEventListener('input', (e)=> filterEvents(e.target.value));

      // exporta storedEvents como arquivo JSON
      function downloadJSON(filename, data){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
      }
      if(exportBtn) exportBtn.addEventListener('click', ()=> downloadJSON('agenda-events.json', storedEvents));
      if(exportListBtn) exportListBtn.addEventListener('click', ()=> downloadJSON('agenda-events.json', storedEvents));

      // Today button handler (leva o calend√°rio √† data atual)
      if(goTodayBtn) goTodayBtn.addEventListener('click', ()=> { current = new Date(); render(); });

      function clearContent(){ content.innerHTML = ''; selectedIndex = null; }

      function announce(text){
        // cria/usa um elemento aria-live para anunciar mudan√ßas a leitores de tela
        let live = document.getElementById('a11yAnnounce');
        if(!live){ live = document.createElement('div'); live.id='a11yAnnounce'; live.setAttribute('aria-live','polite'); live.style.position='absolute'; live.style.left='-9999px'; document.body.appendChild(live); }
        live.textContent = text;
      }

      function makeCell(day){
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        cell.setAttribute('role','gridcell');
        cell.tabIndex = -1; // somente selected ter√° tabindex=0
        const dayNum = document.createElement('div'); dayNum.className = 'day-num'; dayNum.textContent = day;
        cell.appendChild(dayNum);

        const ev = document.createElement('div'); ev.className = 'event-info';
        ev.innerHTML = '<span class="event-dot"></span>';
        cell.appendChild(ev);

        if (eventDays.includes(day)) cell.classList.add('has-event');
        return cell;
      }

      function focusCellByIndex(idx){
        const cells = Array.from(content.querySelectorAll('.calendar-cell:not(.empty)'));
        if (!cells[idx]) return;
        // remove tabindex do anterior
        cells.forEach(c => c.tabIndex = -1);
        const c = cells[idx];
        c.tabIndex = 0;
        c.focus();
        // visual
        content.querySelectorAll('.calendar-cell.selected').forEach(x=>x.classList.remove('selected'));
        c.classList.add('selected');
        selectedIndex = idx;
        // informar usu√°rio via SR
        const num = c.querySelector('.day-num')?.textContent || '';
        announce(`${num} de ${current.toLocaleString('pt-BR',{ month:'long', year:'numeric' })}`);
      }

      function renderMonth(){
        clearContent();
        content.classList.remove('week-view','day-view');
        weekdayLabels.style.display = 'grid';

        const first = new Date(current.getFullYear(), current.getMonth(), 1);
        const last = new Date(current.getFullYear(), current.getMonth() + 1, 0);
        const startDay = first.getDay();
        const daysInMonth = last.getDate();

        title.textContent = first.toLocaleString('pt-BR',{ month:'long', year:'numeric' });
        agendaMonthLabel.textContent = first.toLocaleString('pt-BR',{ month:'long' });
        announce(title.textContent);

        for(let i=0;i<startDay;i++){
          const empty = document.createElement('div'); empty.className='calendar-cell empty'; empty.setAttribute('aria-hidden','true');
          content.appendChild(empty);
        }

        // cria lista de c√©lulas leg√≠veis e focus√°veis
        for(let day=1; day<=daysInMonth; day++){
          const cell = document.createElement('div'); cell.className='calendar-cell';
          const num = document.createElement('div'); num.className = 'day-num'; num.textContent = day;
          cell.appendChild(num);

          if(eventDays.includes(day)){
            cell.classList.add('has-event');
            const dot = document.createElement('div'); dot.className='event-dot'; cell.appendChild(dot);
          }
          // clique: navegar para a tela de cria√ß√£o (pr√©-preenche com ano/m√™s/dia)
          cell.addEventListener('click', ()=> {
            const y = current.getFullYear();
            const m = current.getMonth(); // zero-based (compat√≠vel com leitura em addEventScreen.html)
            window.location.href = `addEventScreen.html?y=${y}&m=${m}&d=${day}`;
          });
 
          content.appendChild(cell);
        }

        const total = startDay + daysInMonth;
        const trailing = (7 - (total % 7)) % 7;
        for(let i=0;i<trailing;i++){ const empty=document.createElement('div'); empty.className='calendar-cell empty'; empty.setAttribute('aria-hidden','true'); content.appendChild(empty); }

        // set primeiro foco no dia atual, se vis√≠vel; sen√£o no primeiro dia
        const nonEmpty = Array.from(content.querySelectorAll('.calendar-cell:not(.empty)'));
        const today = new Date();
        let initialIdx = 0;
        if (today.getMonth() === current.getMonth() && today.getFullYear() === current.getFullYear()){
          const idx = today.getDate() - 1; // 0-based
          initialIdx = idx;
        }
        focusCellByIndex(initialIdx);
      }

      function renderWeek(){
        clearContent();
        content.classList.add('week-view'); content.classList.remove('day-view'); weekdayLabels.style.display='grid';
        const cur = new Date(current); const dayOfWeek = cur.getDay();
        const sunday = new Date(cur); sunday.setDate(cur.getDate() - dayOfWeek);
        const endDate = new Date(sunday); endDate.setDate(sunday.getDate() + 6);
        title.textContent = `${sunday.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
        agendaMonthLabel.textContent = sunday.toLocaleString('pt-BR',{ month:'long' });
        announce(title.textContent);

        for(let i=0;i<7;i++){
          const d = new Date(sunday); d.setDate(sunday.getDate()+i);
          const dayNumVal = d.getDate();
          const cell = makeCell(dayNumVal);
          cell.classList.add('week');
          // marca evento apenas para dias do m√™s atual
          if (current.getMonth() === d.getMonth() && eventDays.includes(dayNumVal)) cell.classList.add('has-event');
          content.appendChild(cell);
        }
        // set focus no primeiro dia da semana
        focusCellByIndex(0);
      }

      function renderDay(){
        clearContent();
        content.classList.add('day-view'); content.classList.remove('week-view'); weekdayLabels.style.display='none';
        title.textContent = current.toLocaleDateString('pt-BR', { weekday: 'long', year:'numeric', month:'long', day:'numeric' });
        announce(title.textContent);
        const cell = makeCell(current.getDate()); cell.classList.add('day-focus');
        if (eventDays.includes(current.getDate())) cell.classList.add('has-event');
        content.appendChild(cell);
        focusCellByIndex(0);
      }

      function render(){ if(view==='month') renderMonth(); else if(view==='week') renderWeek(); else renderDay(); }

      // navega√ß√£o e atalho por teclado (fica global √† p√°gina)
      document.addEventListener('keydown', (e)=>{
        // abrir novo evento: tecla N
        if (e.key.toLowerCase() === 'n') { document.getElementById('openCreateBtn').click(); return; }
        // mover sele√ß√£o dentro das c√©lulas (setas) quando um cell tem foco ou quando calendar tem foco
        const cells = Array.from(content.querySelectorAll('.calendar-cell:not(.empty)'));
        if (!cells.length) return;
        if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Enter'].includes(e.key)) {
          e.preventDefault();
          if (selectedIndex === null) selectedIndex = 0;
          let idx = selectedIndex;
          if (e.key === 'ArrowLeft') idx = Math.max(0, idx - 1);
          if (e.key === 'ArrowRight') idx = Math.min(cells.length -1, idx + 1);
          if (e.key === 'ArrowUp') idx = Math.max(0, idx - 7);
          if (e.key === 'ArrowDown') idx = Math.min(cells.length -1, idx + 7);
          if (e.key === 'Enter') {
            // Enter: abre a tela de adicionar evento para o dia selecionado
            const cell = cells[selectedIndex];
            const day = parseInt(cell.querySelector('.day-num').textContent,10);
            const y = current.getFullYear();
            const m = current.getMonth();
            window.location.href = `addEventScreen.html?y=${y}&m=${m}&d=${day}`;
            return;
          }
          focusCellByIndex(idx);
        }
      });

      // Prev/Next handlers (mant√©m comportamento anterior)
      document.getElementById('prevBtn').addEventListener('click', function(){
        if(view==='month') current.setMonth(current.getMonth()-1);
        else if(view==='week') current.setDate(current.getDate()-7);
        else current.setDate(current.getDate()-1);
        render();
      });
      document.getElementById('nextBtn').addEventListener('click', function(){
        if(view==='month') current.setMonth(current.getMonth()+1);
        else if(view==='week') current.setDate(current.getDate()+7);
        else current.setDate(current.getDate()+1);
        render();
      });

      // view-toggle buttons (mant√©m)
      document.querySelectorAll('.view-toggle .btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          view = this.getAttribute('data-view');
          document.querySelectorAll('.view-toggle .btn').forEach(b=>b.classList.remove('primary'));
          this.classList.add('primary');
          render();
        });
      });

      // modal: reutiliza event modal j√° presente no HTML
      const openCreateBtn = document.getElementById('openCreateBtn');
      const eventModal = document.getElementById('eventModal');
      const closeModal = document.getElementById('closeModal');
      const cancelEvent = document.getElementById('cancelEvent');
      const eventForm = document.getElementById('eventForm');
 
      // Ao clicar no "+" abrimos a tela de adicionar evento (sem dia pr√©-selecionado).
      openCreateBtn.addEventListener('click', ()=> {
        const y = current.getFullYear();
        const m = current.getMonth();
        window.location.href = `addEventScreen.html?y=${y}&m=${m}`;
      });
      function openModalPrefill(day){
        eventModal.style.display = 'flex';
        const dayInput = document.getElementById('evtDay');
        if(dayInput && day) dayInput.value = day;
        const titleInput = document.getElementById('evtTitle');
        if(titleInput) titleInput.focus();
      }
      function hideModal(){ eventModal.style.display = 'none'; eventForm.reset(); }
       closeModal.addEventListener('click', hideModal);
       cancelEvent.addEventListener('click', hideModal);

      // submiss√£o do modal (mant√©m l√≥gica de envio/fallback)
      eventForm.addEventListener('submit', function(e){
        e.preventDefault();
        const titleVal = document.getElementById('evtTitle').value.trim();
        const dayVal = parseInt(document.getElementById('evtDay').value,10);
        const timeVal = document.getElementById('evtTime').value.trim();
        const noteVal = document.getElementById('evtNote').value.trim();

        if(!titleVal || !dayVal || isNaN(dayVal)) {
          alert('Preencha t√≠tulo e dia (n√∫mero).');
          return;
        }

        // tenta enviar ao backend; se falhar, faz fallback local
        const payload = { day: dayVal, title: titleVal, time: timeVal, note: noteVal };

        // BACKEND: endpoint para criar evento
        // POST /events
        // - Content-Type: application/json
        // - body: { day: Number, title: String, time?: String, note?: String, month?: Number, year?: Number }
        // - resposta esperada (200/201): JSON com o evento criado, por exemplo:
        //    { id: 42, day: 10, title: 'Prova', time: '09:30', note: 'Sala A' }
        // - Dica: se backend retornar o novo dia/ID, usamos esses valores para atualizar UI local.
        fetch('/events', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(res => {
          if (!res.ok) throw new Error('Erro ao criar evento');
          return res.json();
        }).then(created => {
          addEventToList({ day: created.day || dayVal, title: created.title || titleVal, time: created.time || timeVal, note: created.note || noteVal });
          if (!eventDays.includes(created.day || dayVal)) eventDays.push(created.day || dayVal);
          hideModal();
          render();
        }).catch(err => {
          console.warn('POST /events falhou, fallback local', err);
          addEventToList({ day: dayVal, title: titleVal, time: timeVal, note: noteVal });
          if (!eventDays.includes(dayVal)) eventDays.push(dayVal);
          hideModal();
          render();
        });
       });

      // Inicializa filtro / parsing
      parseInitialAppointments();
      // inicial
      render();

    })();
  </script>

  <script src="accessibility.js"></script>
</body>
</html>
